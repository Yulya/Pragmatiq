{% extends "_api_base.html" %}

{% block script %}
<script type="text/javascript">

var form_key= '{{key}}';
var form_type='{{type}}';

function send_value(id, value) {
   $.post('/pr/data/update/'+ id, {value: value});
}

$(document).ready(function() {
    /*
    if (form_type == 'main') {
        // I don't expect we render JavaScript this way
        {# {% for goal in prev_goals %} #}
            $('#prev_goals').append('<select id="{{goal.key}}"></select>');
            $('#{{goal.key}}').append('<option value="1" class="grade">below expectations</option>');
            $('#{{goal.key}}').append('<option value="2" class="grade">meet expectations</option>');
            $('#{{goal.key}}').append('<option value="3" class="grade">above expectations</option>');
            $('#prev_goals').append('{{goal.value}}<br>');
        {# {% endfor %} #}
    }
    */

    $('.grade').click(function() {
        var id = $(this).parent().attr('id');
        $.post('/pr/data/update/'+id, {'grade': this.value}, function(data){alert(data)})
    });

    $('.add_button').click(function() {
        var button = $(this);
        var table = button.parent().attr('id');
        $.post(
            '/pr/data/add',
            {form_key: form_key, table: table},
            function(data){
                $('<input type="text" size="75">').attr('id',data).focusout(function(){
                    $.post('/pr/data/update/'+this.id, {value: this.value})
                }).insertBefore(button)
            }
        )
    });
})
</script>
{% endblock %}

{% block content %}
<p>Performance Review Form for {{emp.first_name}} {{emp.last_name}}</p>
<p>Manager: {{author.first_name}} {{author.last_name}}</p>
<p>date: {{date}}</p>

<div id="prev_goals" class="input_div">
    <p>Previous Goals:</p>
    <table>
        <thead>
            <tr>
                <td>Goal</td>
                <td>Value</td>
            </tr>
        </thead>
    {% for prev_goal in prev_goals %}
        <tr>
            <td>{{prev_goal.value}}</td>
            <td>
                <select id="{{prev_goal.key}}">
                    <option value="1" class="grade">below expectations</option>
                    <option value="2" class="grade">meet expectations</option>
                    <option value="3" class="grade">above expectations</option>
                </select>
                <script type="text/javascript" language="JavaScript">
                    $("#{{prev_goal.key}}").val("{{prev_goal.result}}");
                </script>
            </td>
        </tr>
    {% endfor %}
    </table>
</div>

<div id="next_goals" class="input_div">
    <p>Goals for the next period:</p>
    {% for goal in next_goals %}
        <input type="text" size="75" id="{{goal.key}}" value="{{goal.value}}" onblur="send_value(id, value)">
    {% endfor %}
    <input type="button" class="add_button" value="add" >
</div>

<div id="achievements" class="input_div">
    <p>Achievements:</p>
    {% for ach in achievements %}
        <input type="text" size="75" id="{{ach.key}}" value="{{ach.value}}" onblur="send_value(id, value)">
    {% endfor %}
    <input type="button" class="add_button" value="add" >
</div>

<div id="challenges" class="input_div">
    <p>Challenges:</p>
    {% for challenge in challenges %}
        <!-- todo: use css class instead of properties -->
        <input type="text" size="75" id="{{challenge.key}}" value="{{challenge.value}}" onblur="send_value(id, value)">
    {% endfor %}
    <input type="button" class="add_button" value="add" >
</div>

<div id="conclusions">
    <p>Performance conclusion:</p>
    <!-- todo insert logic here -->
</div>

<div>
    <p>Attached files:</p>
    {% if file_name%}
        <a href="/serve/{{file_key}}">{{file_name}}</a>
    {% endif %}
</div>

<div>
    <form action="{{upload_url}}" method="POST" enctype="multipart/form-data">
        <input type='hidden' name='key' value={{key}}>
        <input type="file" name="file"><br>
        <input type="submit" name="submit" value="attach">
    </form>
</div>

{% endblock %}